<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Bodega</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .hidden { display: none; }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Registro de Movimiento</h2>

  <label for="seccion">Tipo de Registro</label>
  <select id="seccion">
    <option value="">Seleccione...</option>
    <option value="salida">A. Salida de equipos</option>
    <option value="entrada">B. Entrada de equipos</option>
    <option value="otro">C. Otro Motivo</option>
  </select>

  <form id="formulario" class="hidden">
    <label>Técnico</label>
    <input name="tecnico" required>

    <label>Tipo de Movimiento</label>
    <select name="tipo_movimiento">
      <option>Salida</option>
      <option>Entrada</option>
      <option>Otro</option>
    </select>

    <label>Hora de Entrada</label>
    <input type="time" name="hora_entrada" required>

    <div id="datosAdicionales">
      <label>Código Retirado</label>
      <input name="codigo_retirado">
      <label>Serie Retirada</label>
      <input name="serie_retirada">
      <label>Descripción</label>
      <input name="descripcion">
      <label>ID de Sitio</label>
      <input name="id_sitio">
      <label>Nombre de Sitio</label>
      <input name="nombre_sitio">
      <label>Foto de Parte</label>
      <input type="file" name="foto_parte" accept="image/*">
      <label>Foto de Serie</label>
      <input type="file" name="foto_serie" accept="image/*">
    </div>

    <label>Comentario</label>
    <textarea name="comentario"></textarea>

    <button type="submit">Enviar</button>
  </form>
</div>

<script>
  const seccion = document.getElementById('seccion');
  const form = document.getElementById('formulario');
  const datos = document.getElementById('datosAdicionales');

  // Mostrar/ocultar campos según sección
  seccion.addEventListener('change', () => {
    form.classList.remove('hidden');
    const tipo = seccion.value;
    const entradas = datos.querySelectorAll('input');
    if (tipo === 'otro') {
      entradas.forEach(el => {
        if (el.type === 'file') el.disabled = true;
        else el.value = 'N/A';
      });
    } else {
      entradas.forEach(el => {
        el.disabled = false;
        if (el.type !== 'file') el.value = '';
      });
    }
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    data.fotoParteURL = await toBase64(formData.get('foto_parte'));
    data.fotoSerieURL = await toBase64(formData.get('foto_serie'));

    const proxy = "https://corsproxy.io/?";
    const scriptURL = "https://script.google.com/macros/s/AKfycbzWInYPLtjrKf8Jfaey09DODsHfmpKnfG6khN5RKDoP76mSdF40j5okYSid-JIamS5v/exec";
    const fullURL = proxy + encodeURIComponent(scriptURL);

    try {
      const res = await fetch(fullURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const json = await res.json();
      if (json.status === 'ok') {
        alert('✅ Registro exitoso');
        form.reset();
        form.classList.add('hidden');
      } else {
        alert('❌ Error: ' + json.message);
      }
    } catch (err) {
      alert('❌ Error de conexión: ' + err.message);
    }
  });

  function toBase64(file) {
    return new Promise(resolve => {
      if (!file || file.size === 0) return resolve('');
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
