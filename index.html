<script>
  const seccion = document.getElementById('seccion');
  const form = document.getElementById('formulario');
  const datos = document.getElementById('datosAdicionales');

  // Rellenar formulario desde la URL si hay parámetros
  window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const keys = ['tecnico', 'tipo_movimiento', 'hora_entrada', 'codigo_retirado', 'serie_retirada',
                  'descripcion', 'id_sitio', 'nombre_sitio', 'comentario'];

    let hayDatos = false;
    keys.forEach(key => {
      if (params.has(key)) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
          input.value = decodeURIComponent(params.get(key));
          hayDatos = true;
        }
      }
    });

    // Muestra el formulario si hay datos
    if (hayDatos) {
      form.classList.remove('hidden');
    }
  });

  seccion.addEventListener('change', () => {
    form.classList.remove('hidden');
    const tipo = seccion.value;
    const entradas = datos.querySelectorAll('input');
    if (tipo === 'otro') {
      entradas.forEach(el => {
        if (el.type === 'file') el.disabled = true;
        else el.value = 'N/A';
      });
    } else {
      entradas.forEach(el => {
        el.disabled = false;
        if (el.type !== 'file') el.value = '';
      });
    }
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    data.fotoParteURL = await toBase64(formData.get('foto_parte'));
    data.fotoSerieURL = await toBase64(formData.get('foto_serie'));

    try {
      const res = await fetch('https://script.google.com/macros/s/AKfycbzWInYPLtjrKf8Jfaey09DODsHfmpKnfG6khN5RKDoP76mSdF40j5okYSid-JIamS5v/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (json.status === 'ok') {
        alert('✅ Registro exitoso');
        form.reset();
        form.classList.add('hidden');
      } else {
        alert('❌ Error: ' + json.message);
      }
    } catch (err) {
      alert('❌ Error de conexión: ' + err.message);
    }
  });

  function toBase64(file) {
    return new Promise(resolve => {
      if (!file || file.size === 0) return resolve('');
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }
</script>
