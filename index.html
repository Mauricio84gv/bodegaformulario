<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Bodega – Repuestos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        body{background:#f8f9fa;}
        .badge{font-size:.85em;}
    </style>
</head>
<body>
<div class="container py-4">
    <h2 class="mb-4 text-center">Control de Bodega – Repuestos</h2>

    <!-- ACCORDEON -->
    <div class="accordion" id="accordionBodega">
        <!-- ENTRADA DE EQUIPO -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#entradaCollapse">
                    Entrada de equipo
                </button>
            </h2>
            <div id="entradaCollapse" class="accordion-collapse collapse" data-bs-parent="#accordionBodega">
                <div class="accordion-body">
                    <form id="formEntrada">
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">Tipo de equipo</label><input type="text" class="form-control" name="tipo" required></div>
                            <div class="col-md-3"><label class="form-label">Modelo</label><input type="text" class="form-control" name="modelo" required></div>
                            <div class="col-md-3"><label class="form-label">Serie</label><input type="text" class="form-control" name="serie" required></div>
                            <div class="col-md-3"><label class="form-label">Técnico que ingresa</label><input type="text" class="form-control" name="tecnicoEntrada" required></div>

                            <div class="col-md-6"><label class="form-label">Fecha y hora de entrada</label><input type="text" class="form-control datetime" name="fechaHoraEntrada" required></div>
                            <div class="col-md-6"><label class="form-label">Hora de salida de bodega <span class="text-danger">*</span></label><input type="time" class="form-control" name="horaSalidaBodega" required></div>

                            <div class="col-md-6">
                                <label class="form-label">Motivo</label>
                                <select class="form-select" name="motivo" required>
                                    <option value="">Seleccione...</option>
                                    <option>Ingreso nuevo</option>
                                    <option>Devolución</option>
                                    <option>Otro</option>
                                </select>
                            </div>
                            <div class="col-12 d-none" id="otroEntrada">
                                <label class="form-label">Explique caso especial</label>
                                <input type="text" class="form-control" name="otroTexto">
                            </div>
                        </div>
                        <button class="btn btn-success mt-3">Guardar entrada</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- SALIDA DE EQUIPO -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#salidaCollapse">
                    Salida de equipo
                </button>
            </h2>
            <div id="salidaCollapse" class="accordion-collapse collapse" data-bs-parent="#accordionBodega">
                <div class="accordion-body">
                    <form id="formSalida">
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">Tipo de equipo</label><input type="text" class="form-control" name="tipo" required></div>
                            <div class="col-md-3"><label class="form-label">Modelo</label><input type="text" class="form-control" name="modelo" required></div>
                            <div class="col-md-3"><label class="form-label">Serie</label><input type="text" class="form-control" name="serie" required></div>
                            <div class="col-md-3"><label class="form-label">ID del sitio destino</label><input type="text" class="form-control" name="idSitio" required></div>

                            <div class="col-md-4"><label class="form-label">Técnico que retira</label><input type="text" class="form-control" name="tecnicoSalida" required></div>
                            <div class="col-md-4"><label class="form-label">Fecha y hora de salida</label><input type="text" class="form-control datetime" name="fechaHoraSalida" required></div>
                            <div class="col-md-4"><label class="form-label">Hora de salida de bodega <span class="text-danger">*</span></label><input type="time" class="form-control" name="horaSalidaBodega" required></div>

                            <div class="col-12"><label class="form-label">Observaciones</label><input type="text" class="form-control" name="obsSalida"></div>
                        </div>
                        <button class="btn btn-primary mt-3">Guardar salida</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- INVENTARIO / ENTRADA TÉCNICO -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#inventarioCollapse">
                    Inventario
                </button>
            </h2>
            <div id="inventarioCollapse" class="accordion-collapse collapse" data-bs-parent="#accordionBodega">
                <div class="accordion-body">
                    <form id="formInventario">
                        <div class="row g-3">
                            <div class="col-md-4"><label class="form-label">Técnico que ingresa</label><input type="text" class="form-control" name="tecnicoEntrada" required></div>
                            <div class="col-md-4"><label class="form-label">Fecha y hora de registro</label><input type="text" class="form-control datetime" name="fechaHoraRegistro" required></div>
                            <div class="col-md-4"><label class="form-label">Hora de salida de bodega <span class="text-danger">*</span></label><input type="time" class="form-control" name="horaSalidaBodega" required></div>

                            <div class="col-12"><label class="form-label">Observaciones / detalle</label><input type="text" class="form-control" name="obsInventario"></div>
                        </div>
                        <button class="btn btn-secondary mt-3">Guardar inventario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA RESUMEN -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Movimientos</span>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="exportCSV()">Exportar CSV</button>
                <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importCSV(event)">
                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="document.getElementById('importFile').click()">Importar CSV</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Fecha/Hora</th><th>Mov</th><th>Tipo</th><th>Modelo</th><th>Serie</th>
                        <th>Técnico entrada</th><th>Técnico salida</th><th>ID sitio</th>
                        <th>Hora salida bodega</th><th>Motivo/Obs</th><th></th>
                    </tr>
                    </thead>
                    <tbody id="movimientos"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
<script>
// ---------- CONFIG FECHA/HORA ----------
flatpickr('.datetime', { enableTime: true, dateFormat: 'd/m/Y H:i', locale: 'es' });

// ---------- CONFIGURAR TU WEB APP ----------
// 1. Reemplazá esta URL por la que obtengas al desplegar tu Google Apps Script
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxLPjZnKIRU4Vd_IMnIWzwMD9NYwGc_ZtmfdlJolT5v_IPnPMZl4svZE-T_39u87HDoGg/exec';

// ---------- CRUD LOCAL + SHEETS ----------
const LS_KEY = 'bodegaMovs';
let movimientos = JSON.parse(localStorage.getItem(LS_KEY) || '[]');

function save() {
  localStorage.setItem(LS_KEY, JSON.stringify(movimientos));
  render();
}
function addMov(mov) {
  mov.id = Date.now();
  movimientos.unshift(mov);
  save();
  sendToSheets(mov);        // Envío a Google Sheets
}
function render() {
  const tbody = document.getElementById('movimientos');
  tbody.innerHTML = movimientos.map(m => `
    <tr>
      <td>${m.fechaHora}</td>
      <td><span class="badge ${m.tipoMov==='ENTRADA'?'bg-success': m.tipoMov==='SALIDA'?'bg-primary':'bg-secondary'}">${m.tipoMov}</span></td>
      <td>${m.tipo || '—'}</td><td>${m.modelo || '—'}</td><td>${m.serie || '—'}</td>
      <td>${m.tecnicoEntrada || '—'}</td><td>${m.tecnicoSalida || '—'}</td>
      <td>${m.idSitio || '—'}</td>
      <td>${m.horaSalidaBodega || '—'}</td>
      <td>${m.motivo || m.obsSalida || m.obsInventario || ''}</td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="eliminar(${m.id})">Eliminar</button></td>
    </tr>`).join('');
}
render();

function eliminar(id) {
  if (confirm('¿Eliminar este movimiento?')) {
    movimientos = movimientos.filter(m => m.id !== id);
    save();
  }
}

// ---------- ENVIAR DATOS A SHEETS ----------
function sendToSheets(payload) {
  fetch(SHEETS_URL, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(() => console.log('✅ Guardado en Sheets'))
  .catch(err => console.error('❌ Error al guardar en Sheets', err));
}

// ---------- FORMULARIOS ----------
document.getElementById('formEntrada').addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  addMov({
    tipoMov: 'ENTRADA',
    tipo: fd.get('tipo'),
    modelo: fd.get('modelo'),
    serie: fd.get('serie'),
    tecnicoEntrada: fd.get('tecnicoEntrada'),
    fechaHora: fd.get('fechaHoraEntrada'),
    horaSalidaBodega: fd.get('horaSalidaBodega'),
    motivo: fd.get('motivo') === 'Otro' ? fd.get('otroTexto') : fd.get('motivo')
  });
  e.target.reset();
  document.getElementById('otroEntrada').classList.add('d-none');
  bootstrap.Collapse.getInstance(document.getElementById('entradaCollapse')).hide();
});

document.getElementById('formSalida').addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  addMov({
    tipoMov: 'SALIDA',
    tipo: fd.get('tipo'),
    modelo: fd.get('modelo'),
    serie: fd.get('serie'),
    tecnicoSalida: fd.get('tecnicoSalida'),
    fechaHora: fd.get('fechaHoraSalida'),
    horaSalidaBodega: fd.get('horaSalidaBodega'),
    idSitio: fd.get('idSitio'),
    obsSalida: fd.get('obsSalida')
  });
  e.target.reset();
  bootstrap.Collapse.getInstance(document.getElementById('salidaCollapse')).hide();
});

document.getElementById('formInventario').addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  addMov({
    tipoMov: 'INVENTARIO',
    tecnicoEntrada: fd.get('tecnicoEntrada'),
    fechaHora: fd.get('fechaHoraRegistro'),
    horaSalidaBodega: fd.get('horaSalidaBodega'),
    obsInventario: fd.get('obsInventario')
  });
  e.target.reset();
  bootstrap.Collapse.getInstance(document.getElementById('inventarioCollapse')).hide();
});

// ---------- CSV / IMPORT ----------
function exportCSV() {
  const rows = [['Fecha/Hora', 'Movimiento', 'Tipo', 'Modelo', 'Serie', 'TecnicoEntrada', 'TecnicoSalida', 'IDSitio', 'HoraSalidaBodega', 'Motivo/Obs'],
    ...movimientos.map(m => [m.fechaHora, m.tipoMov, m.tipo || '', m.modelo || '', m.serie || '', m.tecnicoEntrada || '', m.tecnicoSalida || '', m.idSitio || '', m.horaSalidaBodega || '', m.motivo || m.obsSalida || m.obsInventario || ''])];
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bodega_movimientos.csv';
  a.click();
}
function importCSV(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const lines = reader.result.split('\n').slice(1);
    const nuevos = lines.filter(l => l.trim()).map(l => {
      const [f, tipoMov, tipo, modelo, serie, te, ts, idS, hsb, obs] = l.split(',');
      return { fechaHora: f, tipoMov, tipo, modelo, serie, tecnicoEntrada: te, tecnicoSalida: ts, idSitio: idS, horaSalidaBodega: hsb, motivo: obs };
    });
    movimientos = [...nuevos, ...movimientos];
    save();
  };
  reader.readAsText(file);
}

// ---------- MOSTRAR CAMPO OTRO ----------
document.querySelector('select[name="motivo"]').addEventListener('change', e => {
  document.getElementById('otroEntrada').classList.toggle('d-none', e.target.value !== 'Otro');
});
</script>
</body>
</html>

