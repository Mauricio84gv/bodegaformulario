<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Control de Bodega â€“ Repuestos</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<style>
        body{background:#f8f9fa;}
        .badge{font-size:.85em;}
    
.card {
  background: #ffffff;
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
h2 {
  color: #0d6efd;
}
body {
  background: linear-gradient(to right, #e0f7fa, #f1f8e9);
}
</style>
</head>
<body>
<div class="container py-4">
<h2 class="mb-4 text-center">Control de Bodega â€“ Repuestos</h2>
<!-- ACCORDEON -->
<div class="accordion" id="accordionBodega">
<!-- ENTRADA DE EQUIPO -->
<div class="accordion-item">
<h2 class="accordion-header">
<button class="accordion-button collapsed" data-bs-target="#entradaCollapse" data-bs-toggle="collapse" type="button">
                    Entrada de equipo
                </button>
</h2>
<div class="accordion-collapse collapse" data-bs-parent="#accordionBodega" id="entradaCollapse">
<div class="accordion-body">
<form id="formEntrada">
<div class="row g-3">
<div class="col-md-3"><label class="form-label">Tipo de equipo</label><input class="form-control" name="tipo" required="" type="text"/></div>
<div class="col-md-3"><label class="form-label">Modelo</label><input class="form-control" name="modelo" required="" type="text"/></div>
<div class="col-md-3"><label class="form-label">Serie</label><input class="form-control" name="serie" required="" type="text"/></div>
<div class="col-md-3"><label class="form-label">TÃ©cnico que ingresa</label><input class="form-control" name="tecnicoEntrada" required="" type="text"/></div>
<div class="col-md-6"><label class="form-label">Fecha y hora de entrada</label><input class="form-control datetime" name="fechaHoraEntrada" required="" type="text"/></div>
<div class="col-md-6"><label class="form-label">Hora de salida de bodega <span class="text-danger">*</span></label><input class="form-control" name="horaSalidaBodega" required="" type="time"/></div>
<div class="col-md-6">
<label class="form-label">Motivo</label>
<select class="form-select" name="motivo" required="">
<option value="">Seleccione...</option>
<option>Ingreso nuevo</option>
<option>DevoluciÃ³n</option>
<option>Otro</option>
</select>
</div>
<div class="col-12 d-none" id="otroEntrada">
<label class="form-label">Explique caso especial</label>
<input class="form-control" name="otroTexto" type="text"/>
</div>
</div>
<button class="btn btn-success mt-3">Guardar entrada</button>
</form>
</div>
</div>
</div>
<!-- SALIDA DE EQUIPO -->
<div class="accordion-item">
<h2 class="accordion-header">
<button class="accordion-button collapsed" data-bs-target="#salidaCollapse" data-bs-toggle="collapse" type="button">
                    Salida de equipo
                </button>
</h2>
<div class="accordion-collapse collapse" data-bs-parent="#accordionBodega" id="salidaCollapse">
<div class="accordion-body">
<form id="formSalida">
<div class="row g-3">
<div class="col-md-3"><label class="form-label">Tipo de equipo</label><input class="form-control" name="tipo" required="" type="text"/></div>
<div class="col-md-3"><label class="form-label">Modelo</label><input class="form-control" name="modelo" required="" type="text"/></div>
<div class="col-md-3"><label class="form-label">Serie</label><input class="form-control" name="serie" required="" type="text"/></div>
<div class="col-md-3"><label class="form-label">ID del sitio destino</label><input class="form-control" name="idSitio" required="" type="text"/></div>
<div class="col-md-4"><label class="form-label">TÃ©cnico que retira</label><input class="form-control" name="tecnicoSalida" required="" type="text"/></div>
<div class="col-md-4"><label class="form-label">Fecha y hora de salida</label><input class="form-control datetime" name="fechaHoraSalida" required="" type="text"/></div>
<div class="col-md-4"><label class="form-label">Hora de salida de bodega <span class="text-danger">*</span></label><input class="form-control" name="horaSalidaBodega" required="" type="time"/></div>
<div class="col-12"><label class="form-label">Observaciones</label><input class="form-control" name="obsSalida" type="text"/></div>
</div>
<button class="btn btn-primary mt-3">Guardar salida</button>
</form>
</div>
</div>
</div>
<!-- INVENTARIO / ENTRADA TÃ‰CNICO -->
<div class="accordion-item">
<h2 class="accordion-header">
<button class="accordion-button collapsed" data-bs-target="#inventarioCollapse" data-bs-toggle="collapse" type="button">
                    Inventario
                </button>
</h2>
<div class="accordion-collapse collapse" data-bs-parent="#accordionBodega" id="inventarioCollapse">
<div class="accordion-body">
<form id="formInventario">
<div class="row g-3">
<div class="col-md-4"><label class="form-label">TÃ©cnico que ingresa</label><input class="form-control" name="tecnicoEntrada" required="" type="text"/></div>
<div class="col-md-4"><label class="form-label">Fecha y hora de registro</label><input class="form-control datetime" name="fechaHoraRegistro" required="" type="text"/></div>
<div class="col-md-4"><label class="form-label">Hora de salida de bodega <span class="text-danger">*</span></label><input class="form-control" name="horaSalidaBodega" required="" type="time"/></div>
<div class="col-12"><label class="form-label">Observaciones / detalle</label><input class="form-control" name="obsInventario" type="text"/></div>
</div>
<button class="btn btn-secondary mt-3">Guardar inventario</button>
</form>
</div>
</div>
</div>
</div>
<!-- TABLA RESUMEN -->
<div class="card mt-4">
<div class="card-header d-flex justify-content-between align-items-center">
<span>Movimientos</span>
<div>
<input accept=".csv" id="importFile" onchange="importCSV(event)" style="display:none" type="file"/>
</div>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-sm align-middle">
<thead class="table-light">
<tr>
<th>Fecha/Hora</th><th>Mov</th><th>Tipo</th><th>Modelo</th><th>Serie</th>
<th>TÃ©cnico entrada</th><th>TÃ©cnico salida</th><th>ID sitio</th>
<th>Hora salida bodega</th><th>Motivo/Obs</th><th></th>
</tr>
</thead>
<tbody id="movimientos"></tbody>
</table>
</div>
</div>
</div>
<button class="btn btn-primary mt-4" onclick="guardarComoPDF()">ðŸ“„ Guardar como PDF</button></div>
<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
<script>
// ---------- CONFIG FECHA/HORA ----------
flatpickr('.datetime', { enableTime: true, dateFormat: 'd/m/Y H:i', locale: 'es' });

// ---------- CONFIGURAR TU WEB APP ----------
// 1. ReemplazÃ¡ esta URL por la que obtengas al desplegar tu Google Apps Script
const SHEETS_URL = "https://corsproxy.io/?https://script.google.com/macros/s/AKfycbxLPjZnKIRU4Vd_IMnIWzwMD9NYwGc_ZtmfdlJolT5v_IPnPMZl4svZE-T_39u87HDoGg/exec";

// ---------- CRUD LOCAL + SHEETS ----------
const LS_KEY = 'bodegaMovs';
let movimientos = JSON.parse(localStorage.getItem(LS_KEY) || '[]');

function save() {
  localStorage.setItem(LS_KEY, JSON.stringify(movimientos));
  render();
}
function addMov(mov) {
  mov.id = Date.now();
  movimientos.unshift(mov);
  save();
  sendToSheets(mov);        // EnvÃ­o a Google Sheets
}
function render() {
  const tbody = document.getElementById('movimientos');
  tbody.innerHTML = movimientos.map(m => `
    <tr>
      <td>${m.fechaHora}</td>
      <td><span class="badge ${m.tipoMov==='ENTRADA'?'bg-success': m.tipoMov==='SALIDA'?'bg-primary':'bg-secondary'}">${m.tipoMov}</span></td>
      <td>${m.tipo || 'â€”'}</td><td>${m.modelo || 'â€”'}</td><td>${m.serie || 'â€”'}</td>
      <td>${m.tecnicoEntrada || 'â€”'}</td><td>${m.tecnicoSalida || 'â€”'}</td>
      <td>${m.idSitio || 'â€”'}</td>
      <td>${m.horaSalidaBodega || 'â€”'}</td>
      <td>${m.motivo || m.obsSalida || m.obsInventario || ''}</td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="eliminar(${m.id})">Eliminar</button></td>
    </tr>`).join('');
}
render();

function eliminar(id) {
  if (confirm('Â¿Eliminar este movimiento?')) {
    movimientos = movimientos.filter(m => m.id !== id);
    save();
  }
}

// ---------- ENVIAR DATOS A SHEETS ----------
function sendToSheets(payload) {
  fetch(SHEETS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    const alerta = document.createElement('div');
    alerta.className = 'alert alert-success position-fixed bottom-0 end-0 m-3 shadow';
    alerta.innerText = 'âœ… ' + data.message;
    document.body.appendChild(alerta);
    setTimeout(() => alerta.remove(), 3000);
  })
  .catch(error => {
    const alerta = document.createElement('div');
    alerta.className = 'alert alert-danger position-fixed bottom-0 end-0 m-3 shadow';
    alerta.innerText = 'âŒ Error al guardar: ' + error;
    document.body.appendChild(alerta);
    setTimeout(() => alerta.remove(), 4000);
  });
  fetch(SHEETS_URL, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(() => console.log('âœ… Guardado en Sheets'))
  .catch(err => console.error('âŒ Error al guardar en Sheets', err));
}

// ---------- FORMULARIOS ----------
document.getElementById('formEntrada').addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  addMov({
    tipoMov: 'ENTRADA',
    tipo: fd.get('tipo'),
    modelo: fd.get('modelo'),
    serie: fd.get('serie'),
    tecnicoEntrada: fd.get('tecnicoEntrada'),
    fechaHora: fd.get('fechaHoraEntrada'),
    horaSalidaBodega: fd.get('horaSalidaBodega'),
    motivo: fd.get('motivo') === 'Otro' ? fd.get('otroTexto') : fd.get('motivo')
  });
  e.target.reset();
  document.getElementById('otroEntrada').classList.add('d-none');
  bootstrap.Collapse.getInstance(document.getElementById('entradaCollapse')).hide();
});

document.getElementById('formSalida').addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  addMov({
    tipoMov: 'SALIDA',
    tipo: fd.get('tipo'),
    modelo: fd.get('modelo'),
    serie: fd.get('serie'),
    tecnicoSalida: fd.get('tecnicoSalida'),
    fechaHora: fd.get('fechaHoraSalida'),
    horaSalidaBodega: fd.get('horaSalidaBodega'),
    idSitio: fd.get('idSitio'),
    obsSalida: fd.get('obsSalida')
  });
  e.target.reset();
  bootstrap.Collapse.getInstance(document.getElementById('salidaCollapse')).hide();
});

document.getElementById('formInventario').addEventListener('submit', e => {
  e.preventDefault();
  const fd = new FormData(e.target);
  addMov({
    tipoMov: 'INVENTARIO',
    tecnicoEntrada: fd.get('tecnicoEntrada'),
    fechaHora: fd.get('fechaHoraRegistro'),
    horaSalidaBodega: fd.get('horaSalidaBodega'),
    obsInventario: fd.get('obsInventario')
  });
  e.target.reset();
  bootstrap.Collapse.getInstance(document.getElementById('inventarioCollapse')).hide();
});

// ---------- CSV / IMPORT ----------
function exportCSV() {
  const rows = [['Fecha/Hora', 'Movimiento', 'Tipo', 'Modelo', 'Serie', 'TecnicoEntrada', 'TecnicoSalida', 'IDSitio', 'HoraSalidaBodega', 'Motivo/Obs'],
    ...movimientos.map(m => [m.fechaHora, m.tipoMov, m.tipo || '', m.modelo || '', m.serie || '', m.tecnicoEntrada || '', m.tecnicoSalida || '', m.idSitio || '', m.horaSalidaBodega || '', m.motivo || m.obsSalida || m.obsInventario || ''])];
  const csv = rows.map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'bodega_movimientos.csv';
  a.click();
}
function importCSV(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const lines = reader.result.split('\n').slice(1);
    const nuevos = lines.filter(l => l.trim()).map(l => {
      const [f, tipoMov, tipo, modelo, serie, te, ts, idS, hsb, obs] = l.split(',');
      return { fechaHora: f, tipoMov, tipo, modelo, serie, tecnicoEntrada: te, tecnicoSalida: ts, idSitio: idS, horaSalidaBodega: hsb, motivo: obs };
    });
    movimientos = [...nuevos, ...movimientos];
    save();
  };
  reader.readAsText(file);
}

// ---------- MOSTRAR CAMPO OTRO ----------
document.querySelector('select[name="motivo"]').addEventListener('change', e => {
  document.getElementById('otroEntrada').classList.toggle('d-none', e.target.value !== 'Otro');
});
</script>
<script>
function guardarComoPDF() {
  const elemento = document.querySelector('.container');
  const opt = {
    margin:       0.5,
    filename:     'reporte_bodega.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
  };
  html2pdf().from(elemento).set(opt).save();
}
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script></body>
</html>
